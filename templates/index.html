<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Secure Sign | Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --error: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --radius: 12px;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 40px 20px; color: #1e293b; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: var(--card-bg); padding: 25px; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        
        h2 { font-size: 1.1rem; margin-bottom: 15px; font-weight: 700; color: #0f172a; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; }
        
        input[type="file"], textarea { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.9rem; }
        textarea { height: 80px; font-family: monospace; }
        
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn-blue { background: var(--primary); }
        .btn-green { background: var(--success); }
        
        .result-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            display: none;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
        }
        .msg-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .msg-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align:center; margin-bottom:30px;">
        <h1>üîê Secure PDF Dashboard</h1>
    </header>

    <div class="card">
        <h2>Signer un PDF</h2>
        <form id="signForm">
            <div class="form-group">
                <input type="file" name="pdf" required>
            </div>
            <button type="submit" class="btn-blue">G√©n√©rer et T√©l√©charger</button>
        </form>
    </div>

    <div class="card">
        <h2>V√©rifier QR Seulement</h2>
        <form id="verifyqrForm">
            <div class="form-group">
                <label>Code JSON du QR</label>
                <textarea name="qr_data" placeholder='{"hash": "...", "signature": "..."}' required></textarea>
            </div>
            <button type="submit" class="btn-green">Lancer la v√©rification QR</button>
            <div id="verifyPdfResult2" class="result-message"></div>
        </form>
    </div>

    <div class="card">
        <h2>V√©rifier PDF + QR</h2>
        <form id="verifyPdfForm">
            <div class="form-group">
                <label>Fichier PDF sign√©</label>
                <input type="file" name="pdf" required>
            </div>
            <div class="form-group">
                <label>Code JSON du QR</label>
                <textarea name="qr_data" placeholder='{"hash": "...", "signature": "..."}' required></textarea>
            </div>
            <button type="submit" class="btn-green">Lancer la v√©rification compl√®te</button>
            <div id="verifyPdfResult" class="result-message"></div>
        </form>
    </div>
</div>
<div class="card">
    <h2>Appairage Application Mobile</h2>
    <p style="font-size: 0.8rem; color: #64748b;">Scannez ce code avec votre application Ionic pour r√©cup√©rer la cl√© publique de v√©rification.</p>
    <button id="btnGenAuth" class="btn-blue" style="background: #4f46e5;">G√©n√©rer un QR d'Acc√®s Unique</button>
    
    <div id="authQrContainer" style="text-align:center; margin-top:20px; display:none;">
        <img id="authQrImg" src="" style="border: 4px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 200px;">
        <p id="tokenTimer" style="font-size: 0.75rem; color: #ef4444; margin-top:10px;">Usage unique - Expire apr√®s scan</p>
    </div>
</div>


<script>
    function showMessage(elementId, message, isSuccess) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.style.display = 'block';
        el.className = 'result-message ' + (isSuccess ? 'msg-success' : 'msg-error');
    }

    // SIGNATURE
    document.getElementById('signForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const response = await fetch('/sign', { method: 'POST', body: formData });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "document_signe.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
        }
    };

    // VERIFICATION PDF + QR
    document.getElementById('verifyPdfForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Utilisation de la route api/verify_pdf qui g√®re le fichier + les donn√©es
        const response = await fetch('/api/verify_pdf', { 
            method: 'POST', 
            body: formData // On envoie FormData car il y a un fichier
        });
        
        const result = await response.json();
        if (result.valid) {
            showMessage('verifyPdfResult', '‚úÖ Document Authentique et Int√®gre', true);
        } else {
            showMessage('verifyPdfResult', '‚ùå Document Modifi√© ou Signature Invalide', false);
        }
    };

    // VERIFICATION QR SEULEMENT
    document.getElementById('verifyqrForm').onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const qrDataString = formData.get('qr_data');
        
        // Utilisation de la route api/verify_qr qui g√®re le JSON pur
        const response = await fetch('/api/verify_qr', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qrData: qrDataString })
        });
        
        const result = await response.json();
        if (result.valid) {
            showMessage('verifyPdfResult2', '‚úÖ Signature QR Code Authentique', true);
        } else {
            showMessage('verifyPdfResult2', '‚ùå QR Code non reconnu ou invalide', false);
        }
    };

        // Logique pour g√©n√©rer le QR d'authentification
    document.getElementById('btnGenAuth').onclick = async () => {
        const response = await fetch('/api/get_auth_qr');
        const data = await response.json();
        
        if(data.qr_image) {
            document.getElementById('authQrImg').src = "data:image/png;base64," + data.qr_image;
            document.getElementById('authQrContainer').style.display = 'block';
        }
    };
</script>

</body>
</html>